<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Android 8.0 + çš„ Service ä½¿ç”¨ç¬”è®° | ğ‘ºğ’‚ğ’.ğ‘´ğ’</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="åœ¨ Android 8.0 åŠä»¥åï¼ŒGoogle å¯¹ Service è¿›è¡Œäº†è¯¸å¤šçš„æ”¹è¿›ï¼Œä»¥é™åˆ¶å¼€å‘è€…æ»¥ç”¨ Service.ç°åœ¨çš„ Service å’Œ åº”ç”¨æœ¬èº«çš„è”ç³»æ›´åŠ çš„ç´§å¯†ã€‚æ‰€ä»¥å…ˆæ¥äº†è§£ä¸€ä¸‹å‰å°åº”ç”¨å’Œåå°åº”ç”¨">
<meta name="keywords" content="Android">
<meta property="og:type" content="article">
<meta property="og:title" content="Android 8.0 + çš„ Service ä½¿ç”¨ç¬”è®°">
<meta property="og:url" content="https://moshuanghua.com/2018/07/28/42-Android-Service/index.html">
<meta property="og:site_name" content="ğ‘ºğ’‚ğ’.ğ‘´ğ’">
<meta property="og:description" content="åœ¨ Android 8.0 åŠä»¥åï¼ŒGoogle å¯¹ Service è¿›è¡Œäº†è¯¸å¤šçš„æ”¹è¿›ï¼Œä»¥é™åˆ¶å¼€å‘è€…æ»¥ç”¨ Service.ç°åœ¨çš„ Service å’Œ åº”ç”¨æœ¬èº«çš„è”ç³»æ›´åŠ çš„ç´§å¯†ã€‚æ‰€ä»¥å…ˆæ¥äº†è§£ä¸€ä¸‹å‰å°åº”ç”¨å’Œåå°åº”ç”¨">
<meta property="og:locale" content="zh-CN">
<meta property="og:updated_time" content="2019-04-09T11:33:17.117Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Android 8.0 + çš„ Service ä½¿ç”¨ç¬”è®°">
<meta name="twitter:description" content="åœ¨ Android 8.0 åŠä»¥åï¼ŒGoogle å¯¹ Service è¿›è¡Œäº†è¯¸å¤šçš„æ”¹è¿›ï¼Œä»¥é™åˆ¶å¼€å‘è€…æ»¥ç”¨ Service.ç°åœ¨çš„ Service å’Œ åº”ç”¨æœ¬èº«çš„è”ç³»æ›´åŠ çš„ç´§å¯†ã€‚æ‰€ä»¥å…ˆæ¥äº†è§£ä¸€ä¸‹å‰å°åº”ç”¨å’Œåå°åº”ç”¨">
  
  
    <link rel="icon" href="/favicon.ico">
  
  <link rel="stylesheet" href="/css/style.css">
  <script src="https://libs.baidu.com/jquery/1.9.0/jquery.js"></script>
  
</head>
<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
	<header id="header" class="inner">
		<a href="/" class="profilepic">
			<img lazy-src="https://avatars3.githubusercontent.com/u/8361358?s=460&amp;v=4" class="js-avatar">
		</a>

		<hgroup>
		  <h1 class="header-author"><a href="/">ğ‘ºğ’‚ğ’.ğ‘´ğ’</a></h1>
		</hgroup>

		
		<p class="header-subtitle">æŠ€æœ¯ä¸ç”Ÿæ´»å¹¶è‚©ä½œæˆ˜ã€‚</p>
		

		
			<div class="switch-btn">
				<div class="icon">
					<div class="icon-ctn">
						<div class="icon-wrap icon-house" data-idx="0">
							<div class="birdhouse"></div>
							<div class="birdhouse_holes"></div>
						</div>
						<div class="icon-wrap icon-ribbon hide" data-idx="1">
							<div class="ribbon"></div>
						</div>
						
						<div class="icon-wrap icon-link hide" data-idx="2">
							<div class="loopback_l"></div>
							<div class="loopback_r"></div>
						</div>
						
						
					</div>
					
				</div>
				<div class="tips-box hide">
					<div class="tips-arrow"></div>
					<ul class="tips-inner">
						<li>èœå•</li>
						<li>æ ‡ç­¾</li>
						
						<li>å‹æƒ…é“¾æ¥</li>
						
						
					</ul>
				</div>
			</div>
		

		<div class="switch-area">
			<div class="switch-wrap">
				<section class="switch-part switch-part1">
					<nav class="header-menu">
						<ul>
						
							<li><a href="/">ä¸»é¡µ</a></li>
				        
							<li><a href="/archives">å½’æ¡£</a></li>
				        
							<li><a href="/about">å…³äº</a></li>
				        
						</ul>
					</nav>
					<nav class="header-nav">
						<div class="social">
							
								<a class="github" target="_blank" href="https://github.com/shuanghua" title="github">github</a>
					        
								<a class="mail" target="_blank" href="/shhua17@gmail.com" title="mail">mail</a>
					        
						</div>
					</nav>
				</section>
				
				
				<section class="switch-part switch-part2">
					<div class="widget tagcloud" id="js-tagcloud">
						<a href="/tags/Android/" style="font-size: 20px;">Android</a> <a href="/tags/Java/" style="font-size: 12.5px;">Java</a> <a href="/tags/Kotlin/" style="font-size: 17.5px;">Kotlin</a> <a href="/tags/Linux/" style="font-size: 15px;">Linux</a> <a href="/tags/Python/" style="font-size: 10px;">Python</a> <a href="/tags/æ‰‹æœº/" style="font-size: 10px;">æ‰‹æœº</a> <a href="/tags/æŠ˜è…¾/" style="font-size: 10px;">æŠ˜è…¾</a> <a href="/tags/æ‚æ–‡/" style="font-size: 10px;">æ‚æ–‡</a> <a href="/tags/ç¡¬ä»¶/" style="font-size: 10px;">ç¡¬ä»¶</a> <a href="/tags/é€šçŸ¥/" style="font-size: 10px;">é€šçŸ¥</a> <a href="/tags/é—²è¯/" style="font-size: 12.5px;">é—²è¯</a>
					</div>
				</section>
				
				
				
				<section class="switch-part switch-part3">
					<div id="js-friends">
					
			          <a target="_blank" class="main-nav-link switch-friends-link" href="https://moshuanghua.com">å‹é“¾</a>
			        
			        </div>
				</section>
				

				
				
			</div>
		</div>
	</header>				
</div>
    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
  	<div class="overlay">
  		<div class="slider-trigger"></div>
  		<h1 class="header-author js-mobile-header hide">ğ‘ºğ’‚ğ’.ğ‘´ğ’</h1>
  	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<div class="profilepic">
				<img lazy-src="https://avatars3.githubusercontent.com/u/8361358?s=460&amp;v=4" class="js-avatar">
			</div>
			<hgroup>
			  <h1 class="header-author">ğ‘ºğ’‚ğ’.ğ‘´ğ’</h1>
			</hgroup>
			
			<p class="header-subtitle">æŠ€æœ¯ä¸ç”Ÿæ´»å¹¶è‚©ä½œæˆ˜ã€‚</p>
			
			<nav class="header-menu">
				<ul>
				
					<li><a href="/">ä¸»é¡µ</a></li>
		        
					<li><a href="/archives">å½’æ¡£</a></li>
		        
					<li><a href="/about">å…³äº</a></li>
		        
		        <div class="clearfix"></div>
				</ul>
			</nav>
			<nav class="header-nav">
				<div class="social">
					
						<a class="github" target="_blank" href="https://github.com/shuanghua" title="github">github</a>
			        
						<a class="mail" target="_blank" href="/shhua17@gmail.com" title="mail">mail</a>
			        
				</div>
			</nav>
		</header>				
	</div>
</nav>
      <div class="body-wrap"><article id="post-42-Android-Service" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2018/07/28/42-Android-Service/" class="article-date">
  	<time datetime="2018-07-27T16:00:00.000Z" itemprop="datePublished">2018-07-28</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Android 8.0 + çš„ Service ä½¿ç”¨ç¬”è®°
    </h1>
  

      </header>
      
      <div class="article-info article-info-post">
        
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Android/">Android</a></li></ul>
	</div>

        
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/Android/">Android</a>
	</div>


        <div class="clearfix"></div>
      </div>
      
    
    <div class="article-entry" itemprop="articleBody">	
      
	  
		
		
        <h1 id="ä¸‰ç§-Service-ç±»å‹ï¼š"><a href="#ä¸‰ç§-Service-ç±»å‹ï¼š" class="headerlink" title="ä¸‰ç§ Service ç±»å‹ï¼š"></a>ä¸‰ç§ Service ç±»å‹ï¼š</h1><ul>
<li>startService</li>
<li>bindService</li>
<li>Scheduled Service è®¡åˆ’æœåŠ¡,ä¾‹å¦‚ï¼šJobScheduler.</li>
</ul>
<a id="more"></a>
<h1 id="Android-8-0-Android-O-API-26"><a href="#Android-8-0-Android-O-API-26" class="headerlink" title="Android 8.0- / Android O- / API 26-"></a>Android 8.0- / Android O- / API 26-</h1><p>åœ¨ Android 8.0 ä¹‹å‰ï¼Œæˆ‘ä»¬è¦åˆ›å»ºä¸€ä¸ª â€œå‰å°â€ Service ï¼Œé€šå¸¸æ˜¯å…ˆ startService() å¯åŠ¨ä¸€ä¸ªåå° Serviceï¼Œç„¶åè°ƒç”¨ startForeground() å°†è¯¥æœåŠ¡æå‡ä¸ºå‰å° Serviceã€‚</p>
<h1 id="Android-8-0-Android-O-API-26-1"><a href="#Android-8-0-Android-O-API-26-1" class="headerlink" title="Android 8.0+ / Android O+ / API 26+"></a>Android 8.0+ / Android O+ / API 26+</h1><p>åœ¨ Android 8.0 åŠä»¥åï¼ŒGoogle å¯¹ Service è¿›è¡Œäº†è¯¸å¤šçš„æ”¹è¿›ï¼Œä»¥é™åˆ¶å¼€å‘è€…æ»¥ç”¨åå° Service.ç°åœ¨çš„ Service å’Œ åº”ç”¨æœ¬èº«çš„è”ç³»æ›´åŠ çš„ç´§å¯†ã€‚æ‰€ä»¥å…ˆæ¥äº†è§£ä¸€ä¸‹å‰å°åº”ç”¨å’Œåå°åº”ç”¨ï¼š</p>
<p>åº”ç”¨å¤„äºå‰å°çš„æ¡ä»¶ï¼š</p>
<ul>
<li>æœ‰ä¸€ä¸ªå¯è§çš„ Activity</li>
<li>æœ‰ä¸€ä¸ªå‰å° Service æ­£åœ¨è¿è¡Œ</li>
<li>bandService æ­£åœ¨å’Œä¸€ä¸ªåˆ«çš„å‰å°åº”ç”¨è¿æ¥</li>
<li>ContentProvider æ­£åœ¨å’Œä¸€ä¸ªåˆ«çš„å‰å°åº”ç”¨è¿æ¥</li>
<li>å­˜åœ¨é€šçŸ¥</li>
<li>æ¥æ”¶å­˜åœ¨ FCM æ¶ˆæ¯</li>
<li>æ‰‹åŠ¨æˆ–ç³»ç»Ÿå¼€æœºåè‡ªåŠ¨å‘æ¡Œé¢æ·»åŠ å¾®ä»¶æ—¶ï¼Œæ­¤æ—¶ä¼šè¯†åˆ«ä¸ºä¸€æ®µæ—¶é—´çš„å‰å°åº”ç”¨ï¼Œæ·»åŠ å®Œæˆåï¼Œå‰å°åº”ç”¨å¯èƒ½ä¼šå› ä¸ºç³»ç»Ÿå¼ºæ€å¯¼è‡´å˜ä¸ºåå°åº”ç”¨ï¼ˆå›½å†… rom è¡¨ç°çš„æ¯”è¾ƒå¤šï¼ŒåŸç”Ÿä¸ä¼šï¼‰</li>
</ul>
<p>å¦‚æœä¸Šè¿°æ¡ä»¶æ»¡è¶³ï¼Œåˆ™ç³»ç»Ÿä¼šè‡ªåŠ¨è¯†åˆ«æˆ‘ä»¬çš„åº”ç”¨ä¸ºå‰å°åº”ç”¨ï¼ˆç³»ç»Ÿå¯èƒ½ç¼“å­˜è¯¥åº”ç”¨è¿›ç¨‹ï¼‰ï¼Œå¦åˆ™è¯†åˆ«ä¸ºåå°åº”ç”¨ï¼ˆç³»ç»Ÿä¸ä¼šä¸ºåå°åº”ç”¨ç¼“å­˜ä»»ä½•è¿›ç¨‹å’ŒæœåŠ¡ï¼‰ã€‚</p>
<blockquote>
<p>å½“æˆ‘ä»¬çš„åº”ç”¨è¢«ç³»ç»Ÿè¯†åˆ«ä¸ºåå°åº”ç”¨æ—¶ï¼Œæ­¤æ—¶ä¸èƒ½è°ƒç”¨ startService æ¥å¯åŠ¨ä»»ä½•æœ‰ä¸€ä¸ªæœåŠ¡ï¼Œä½† bindService ä¾‹å¤–ã€‚åŒæ ·çš„,å½“åº”ç”¨è¢«ç³»ç»Ÿæ€æ­»å¤„äºåå°åº”ç”¨æ—¶ï¼ŒAlarmManager ä¹Ÿå¯åŠ¨ä¸äº† Service ;æ‰€ä»¥åœ¨8.0+ åˆæ˜¯å›½å†…çš„rom,è¿˜æ˜¯ä¸è¦å°è¯•è¿™ç§æ–¹å¼ä¿æ´»æœåŠ¡ã€‚</p>
</blockquote>
<h2 id="ä¸¾ä¸ªä¾‹å­ï¼š"><a href="#ä¸¾ä¸ªä¾‹å­ï¼š" class="headerlink" title="ä¸¾ä¸ªä¾‹å­ï¼š"></a>ä¸¾ä¸ªä¾‹å­ï¼š</h2><p>å‡å¦‚ï¼šå½“æˆ‘ä»¬æœ‰ä¸€ä¸ªç¹é‡çš„ä»»åŠ¡ï¼Œæˆ‘ä»¬å¿…é¡»åœ¨åº”ç”¨å¤„äºåå°çŠ¶æ€ä¸‹å¼€å¯ä¸€ä¸ªå‰å° Service å¼€å¤„ç†æˆ‘ä»¬çš„ä»»åŠ¡ï¼Œå¾€å¾€è¿™ç±»å‹çš„ä»»åŠ¡å¤„ç†è¿‡ç¨‹ä¸­ä¼šå ç”¨å¤§é‡å†…å­˜ï¼Œè€Œå½“ç”¨æˆ·åœ¨ç©æ¸¸æˆï¼Œæ­¤æ—¶å¯èƒ½å°±ä¼šå¯¼è‡´å†…å­˜ç´§å¼ æˆ–è€… CPU å¿™ä¸è¿‡æ¥ï¼Œæœ€ç»ˆç”¨æˆ·æ„Ÿå—åˆ°å¡é¡¿ï¼Œè¿™æ˜¯éå¸¸ç³Ÿç³•çš„ç°è±¡ã€‚åƒè¿™æ ·çš„åœºæ™¯æ®‹å®³äº† Android ç”¨æˆ·è®¸å¤šå¹´ï¼›ç›´åˆ° Android 8.0 å¼€å§‹ï¼Œ Google å¼€å§‹æ•´æ²»è¿™ç§åå°æ‘§æ®‹æ‰‹æœºç³»ç»Ÿæ€§èƒ½çš„ç°è±¡ï¼Œå¹¶æ¨èä½¿ç”¨ JobSchedulerï¼ˆJobScheduler ä¼šè‡ªåŠ¨åœ¨ç³»ç»Ÿç©ºé—²çš„æ—¶å€™å»å¤„ç†è¯¥ä»»åŠ¡ï¼‰ï¼Œæ‰€ä»¥åˆ«åœ¨ TMD çæã€‚å½“ç„¶ Google ä¹Ÿä¸æ˜¯ä¸€åˆ€åˆ‡æ­»ï¼Œå¦‚æœä¸ç”¨ JobScheduler ,è€Œæ˜¯ç»§ç»­ä½¿ç”¨ Service ï¼Œåˆ™ å¿…é¡»åœ¨é€šçŸ¥æ ä¸Šæ˜¾ç¤ºä¸€ä¸ªé€šçŸ¥æ¥è®©ç”¨æˆ·çŸ¥é“ï¼šä½ çš„åº”ç”¨æ­£åœ¨åå°å¹²åäº‹ &lt;0.0&gt;<br>å½“ç„¶å¯¹äºéå¸¸ç¹é‡çš„ä»»åŠ¡ï¼Œä¸”éœ€è¦é€šè¿‡ Service æ¥è¾…åŠ©å®Œæˆï¼Œè¿˜æ˜¯ä¼˜å…ˆæ¨èåœ¨å‰å° Service ä¸­å¤„ç†ï¼Œç„¶åå†è€ƒè™‘ JobSchedulerã€‚</p>
<ul>
<li><p>é‚£ä¹ˆå¦‚ä½•åœ¨ Android 8.0+ åˆ›å»ºä¸€ä¸ªå‰å° Service å‘¢ï¼Ÿ<br>ç­”ï¼šå¿…é¡»ä½¿ç”¨ service.startForeground(int id, Notification notification)ï¼Œæˆ‘ä»¬å¿…é¡»å…ˆåˆ›å»ºé€šçŸ¥é¢æ¿ï¼Œè¿™ä¹ˆåˆ›å»º Service ,ç³»ç»Ÿä¼šåœ¨é€šçŸ¥æ ä¸Šæ˜¾ç¤ºç±»ä¼¼å¾—ï¼šâ€xxxxxåº”ç”¨æ­£åœ¨åå°è¿è¡Œâ€ , ä»¥è®©ç”¨æˆ·æ˜ç¡®çš„çŸ¥é“æˆ‘ä»¬åº”ç”¨å…³é—­åä¾ç„¶æœ‰æœåŠ¡åœ¨è¿è¡Œã€‚è¿™ç§æ–¹å¼æœ‰ä¸€ç‚¹è¦æ³¨æ„ï¼šå½“ä½ è°ƒç”¨ startServiceï¼ˆï¼‰æˆ–è€… startForegroundService æ¥å¯åŠ¨ Service åï¼Œå¿…é¡»åœ¨5 ç§’æ—¶é—´å†…è°ƒç”¨ service.startForeground(int id, Notification notification) æ¥å°†è¿™ä¸ªæœåŠ¡æå‡ä¸ºå‰å°æœåŠ¡ ï¼Œå¦‚æœè¶…è¿‡äº†è¿™ä¸ªæ—¶é—´ï¼Œé‚£ä¹ˆæŠ±æ­‰ï¼Œä¸€ä¸ª IllegalArgumentExceptionï¼šNot allowed to start service Intent ä¾ç„¶é€ç»™ä½ ã€‚è¿™æ ·å¯åŠ¨ä¸€ä¸ªæœåŠ¡çš„å‰æè¿˜æ˜¯é¦–å…ˆåº”ç”¨æœ¬èº«å‡ºäºå‰å°åº”ç”¨ã€‚</p>
</li>
<li><p>é™„ä¸Šä½¿ç”¨ä»£ç ï¼š</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyForeBroundService</span> : <span class="type">Service</span></span>() &#123;</span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onBind</span><span class="params">(intent: <span class="type">Intent</span>?)</span></span>: IBinder? &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onStartCommand</span><span class="params">(intent: <span class="type">Intent</span>?, flags: <span class="type">Int</span>, startId: <span class="type">Int</span>)</span></span>: <span class="built_in">Int</span> &#123;</span><br><span class="line">	<span class="comment">// å¿…é¡»ç”¨é€šçŸ¥æ¥å°† Service æå‡ä¸ºå‰å° Service</span></span><br><span class="line">        customNotification(<span class="string">""</span>, <span class="number">55</span>)</span><br><span class="line"></span><br><span class="line">	<span class="comment">//doWork() æ‰§è¡Œç¨‹åºå…³é—­é€€å‡ºåçš„ä»»åŠ¡</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.onStartCommand(intent, flags, startId)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">customNotification</span><span class="params">(title: <span class="type">String</span>, notificationID: <span class="type">Int</span>)</span></span> &#123;</span><br><span class="line">        <span class="keyword">val</span> intent = Intent(<span class="keyword">this</span>, MainActivity::<span class="class"><span class="keyword">class</span>.<span class="title">java</span>)</span></span><br><span class="line">        <span class="keyword">val</span> pendingIntent = PendingIntent.getActivity(<span class="keyword">this</span>, <span class="number">0</span> <span class="comment">/* request code */</span>,</span><br><span class="line">                intent, PendingIntent.FLAG_UPDATE_CURRENT)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">val</span> builder = NotificationCompat.Builder(<span class="keyword">this</span>, title)</span><br><span class="line">                .setSound(RingtoneManager.getDefaultUri(RingtoneManager.TYPE_NOTIFICATION))</span><br><span class="line">                .setSmallIcon(R.mipmap.ic_launcher)</span><br><span class="line">                .setContentIntent(pendingIntent)</span><br><span class="line">                .setOnlyAlertOnce(<span class="literal">true</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">val</span> mNotificationManager = getSystemService(Context.NOTIFICATION_SERVICE) <span class="keyword">as</span> NotificationManager</span><br><span class="line">        <span class="keyword">if</span> (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.O) &#123;</span><br><span class="line">            <span class="keyword">val</span> channel = NotificationChannel(title,</span><br><span class="line">                    <span class="string">"Channel human readable title"</span>,</span><br><span class="line">                    NotificationManager.IMPORTANCE_DEFAULT)</span><br><span class="line">            mNotificationManager.createNotificationChannel(channel)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">val</span> notification = builder.build()</span><br><span class="line">        startForeground(notificationID, notification)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">companion</span> <span class="keyword">object</span> &#123;</span><br><span class="line">        <span class="keyword">private</span> const <span class="keyword">val</span> TAG = <span class="string">"MyForeBroundService"</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h1 id="JobIntentService"><a href="#JobIntentService" class="headerlink" title="JobIntentService"></a>JobIntentService</h1><p>åœ¨ä¸Šè¿°çš„ä¾‹å­ä¸­è¯´åˆ°ï¼Œé™¤äº†ç”¨å‰å° Service æ¥å¤„ç†ä»»åŠ¡ï¼Œæˆ‘ä»¬è¿˜å¯ä½¿ç”¨ JobScheduler ï¼ŒJobIntentService æ˜¯ Service çš„å­ç±»ï¼Œå’Œ JobScheduler çš„å·¥ä½œæ–¹å¼ç±»ä¼¼ï¼Œéƒ½æ˜¯å½“ç³»ç»Ÿå¤„äºç©ºé—²æ—¶æ‰å»æ‰§è¡Œç›¸åº”çš„ä»»åŠ¡ã€‚ä¸åŸæ¥çš„ Service ä¸åŒçš„æ˜¯ï¼šJobIntentService å¯ä»¥åœ¨ä»»ä½•æ—¶é—´å¯åŠ¨ï¼Œè€Œä»€ä¹ˆæ—¶å€™ç»“æŸå°±å¾—çœ‹æ‰‹æœºç³»ç»Ÿ â€œå®‰æ’ï¼â€ã€‚</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DesktopWidgetService</span> : <span class="type">JobIntentService</span></span>() &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onCreate</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onHandleWork</span><span class="params">(intent: <span class="type">Intent</span>)</span></span> &#123;</span><br><span class="line">        <span class="comment">//æ­¤å¤„æ˜¯å­çº¿ç¨‹</span></span><br><span class="line">	<span class="keyword">val</span> weather = getNetWorkData()</span><br><span class="line">	updataWidget(weather)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onDestroy</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">super</span>.onDestroy()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">getNetWorkData</span><span class="params">()</span></span>:Weather &#123;</span><br><span class="line">	<span class="comment">//ä»»åŠ¡ä»£ç </span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">updataWidget</span><span class="params">(weather:<span class="type">Weather</span>)</span></span>&#123;</span><br><span class="line">	MyAppWidgetProvider.updataAppWidget(weather)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">companion</span> <span class="keyword">object</span> &#123;</span><br><span class="line">        <span class="comment">//ä¸€ä¸ª Service å¯¹åº”ä¸€ä¸ª id</span></span><br><span class="line">        <span class="keyword">private</span> const <span class="keyword">val</span> JOB_SERVICE_WIDGET_ID = <span class="number">10111</span></span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">fun</span> <span class="title">enqueueWork</span><span class="params">(context: <span class="type">Context</span>, work: <span class="type">Intent</span>)</span></span> &#123;</span><br><span class="line">            enqueueWork(context, DesktopWidgetService::<span class="class"><span class="keyword">class</span>.<span class="title">java</span>, <span class="type">JOB_SERVICE_WIDGET_ID</span>, <span class="type">work)</span></span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>ä¸Šé¢ä»£ç ï¼šæˆ‘ä»¬å¸Œæœ›åœ¨åº”ç”¨æ¨å‡ºååœ¨åå°ä¸‹è½½å¤©æ°”æ•°æ®ï¼Œç„¶åè®¾ç½®ç»™æˆ‘ä»¬çš„æ¡Œé¢å°éƒ¨ä»¶ã€‚</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DesktopAppWidgetProvider</span> : <span class="type">AppWidgetProvider</span></span>() &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onReceive</span><span class="params">(context: <span class="type">Context</span>?, intent: <span class="type">Intent</span>?)</span></span> &#123;</span><br><span class="line">        <span class="keyword">super</span>.onReceive(context, intent)</span><br><span class="line">	<span class="comment">//è®°å¾—åœ¨ AndroidMainifest æ·»åŠ è¯¥ Action</span></span><br><span class="line">        <span class="keyword">if</span> (intent?.action == ACTION_REFRESH) &#123;</span><br><span class="line">            DesktopWidgetService.enqueueWork(context!!, Intent())</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ¯æ·»åŠ ä¸€ä¸ªæœ¬åº”ç”¨çš„æ¡Œé¢ Widget éƒ½å›è°ƒä¸€æ¬¡</span></span><br><span class="line"><span class="comment">     * xml ä¸­çš„ updatePeriodMillis æ—¶é—´åˆ°äº†ï¼Œå›è°ƒä¸€æ¬¡</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onUpdate</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">            context: <span class="type">Context</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">            appWidgetManager: <span class="type">AppWidgetManager</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">            appWidgetIds: <span class="type">IntArray</span></span></span></span><br><span class="line"><span class="function"><span class="params">    )</span></span> &#123;</span><br><span class="line">        <span class="keyword">super</span>.onUpdate(context, appWidgetManager, appWidgetIds)</span><br><span class="line">        DesktopWidgetService.enqueueWork(context, Intent())</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">companion</span> <span class="keyword">object</span> &#123;</span><br><span class="line">        <span class="function"><span class="keyword">fun</span> <span class="title">updateAppWidget</span><span class="params">(context: <span class="type">Context</span>, <span class="keyword">data</span>: <span class="type">Weather</span>)</span></span> &#123;</span><br><span class="line">            Timber.d(<span class="keyword">data</span>.currentT)</span><br><span class="line">            <span class="keyword">val</span> appWidgetManager = AppWidgetManager.getInstance(context)</span><br><span class="line">            <span class="keyword">val</span> componentName = ComponentName(context, DesktopAppWidgetProvider::<span class="class"><span class="keyword">class</span>.<span class="title">java</span>)</span></span><br><span class="line">            <span class="keyword">val</span> appWidgetIds = appWidgetManager.getAppWidgetIds(componentName)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (appWidgetId <span class="keyword">in</span> appWidgetIds) &#123;</span><br><span class="line">                <span class="keyword">val</span> remoteViews = RemoteViews(context.packageName, R.layout.appwidget_desktop)</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">val</span> refreshIntent = Intent(context, DesktopAppWidgetProvider::<span class="class"><span class="keyword">class</span>.<span class="title">java</span>)</span></span><br><span class="line">                refreshIntent.action = ACTION_REFRESH</span><br><span class="line">                <span class="keyword">val</span> refreshPendingIntent = PendingIntent.getBroadcast(context, <span class="number">11</span>, refreshIntent, <span class="number">11</span>)</span><br><span class="line">                remoteViews.setOnClickPendingIntent(R.id.appwidget_refresh, refreshPendingIntent)</span><br><span class="line"></span><br><span class="line">                remoteViews.setTextViewText(R.id.appwidget_t, <span class="keyword">data</span>.currentT)</span><br><span class="line">                remoteViews.setTextViewText(R.id.appwidget_station, <span class="keyword">data</span>.cityName)</span><br><span class="line">                appWidgetManager.updateAppWidget(appWidgetId, remoteViews)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> const <span class="keyword">val</span> ACTION_REFRESH = <span class="string">"APPWIDGET_REFRESH"</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="è§£å†³å¾®ä»¶åˆ·æ–°æ€è·¯"><a href="#è§£å†³å¾®ä»¶åˆ·æ–°æ€è·¯" class="headerlink" title="è§£å†³å¾®ä»¶åˆ·æ–°æ€è·¯"></a>è§£å†³å¾®ä»¶åˆ·æ–°æ€è·¯</h2><p>åœ¨æ¡Œé¢çš„å°éƒ¨ä»¶ä¸Šï¼Œå®šä¹‰äº†ä¸€ä¸ªåˆ·æ–°æŒ‰é’®ï¼Œç‚¹å‡»è¯¥æŒ‰é’®ï¼Œå‘é€ä¸€ä¸ªå¹¿æ’­(æˆ–è€…åˆ©ç”¨ AlarmManager å®šæ—¶æ¥å‘é€å¹¿æ’­)ï¼Œç„¶ååœ¨ onReceiverï¼ˆï¼‰ä¸­æ¥æ”¶è¯¥å¹¿æ’­ï¼Œæœ€åè°ƒç”¨ DesktopWidgetService.enqueueWork(context, Intent()) æ¥å¯åŠ¨ JobIntentServiceï¼Œè¿™é‡Œä¸€å®šä¸èƒ½æ˜¯æ™®é€šçš„ Service ï¼ŒåŒæ—¶æŠŠ xml/widget_config.xml æ–‡ä»¶ä¸­çš„ android:updatePeriodMillis=â€0â€ è®¾ç½®ä¸º 0ï¼Œæœ€ååœ¨ DesktopWidgetServiceï¼ˆDesktopWidgetService ç»§æ‰¿ JobIntentServiceï¼‰ ä¸­è¯·æ±‚ç½‘ç»œï¼Œåˆ·æ–°å¾®ä»¶ã€‚ç¼ºç‚¹æ˜¯å¯èƒ½ä¸ä¸€å®šå®æ—¶åˆ·æ–°ï¼Œè¯¦ç»†è¯·è‡ªè¡ŒæŸ¥é˜… JobIntentServiceã€‚</p>
<h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p>Service + é€šçŸ¥ ä¹Ÿåªèƒ½åœ¨åº”ç”¨å‡ºäºå‰å°çš„å‰æä¸‹å»åˆ›å»ºå¯åŠ¨ã€‚<br>Service + é€šçŸ¥çš„å½¢å¼ï¼Œåœ¨åŸç”Ÿç³»ç»Ÿä¸Šæ˜¯èƒ½é•¿æ—¶é—´ä¿æŒå‰å°æœåŠ¡çš„è¿è¡Œï¼Œä½†åœ¨å›½å†…æœ‰äº› rom çš„ç¯å¢ƒä¸‹å¹¶ä¸èƒ½å¾ˆå¥½çš„å·¥ä½œï¼Œæ¯”å¦‚ä¸€ä¸ªå¤©æ°”åº”ç”¨ï¼Œæ¡Œé¢å¾®ä»¶æ™šä¸Šç¡è§‰å‰å¥½å¥½çš„ï¼Œç¬¬äºŒå¤©ä¸€æ—©ï¼Œä½ çš„å‰å°æœåŠ¡å°±è¢«å¹²æ­»äº†ï¼Œä½ çš„å¾®ä»¶æ˜¾ç¤º çš„å¤©æ°”æ•°æ®æ˜¯åŠå¤œçš„ï¼Œç„¶åä½ è¿˜ä¸èƒ½é€šè¿‡ç‚¹å‡»å¾®ä»¶å»é‡æ–°å¯åŠ¨ï¼Œå› ä¸ºæ­¤æ—¶ç³»ç»Ÿåå°ä¸å­˜åœ¨ä¸ä½ åº”ç”¨ä»»ä½•ç›¸å…³çš„å†…å­˜ï¼Œä¹Ÿå°±æ˜¯è¯´ä½ çš„åº”ç”¨å·²ç»æ˜¯ä¸€ä¸ªåå°åº”ç”¨ï¼Œä½ æ— æ³•åœ¨åå°å¯åŠ¨åˆ›å»ºæœåŠ¡ã€‚å›½å†…é“é«˜ä¸€å°ºé­”é«˜ä¸€ä¸ˆï¼Œæœ€å—ä¼¤çš„è¿˜æ˜¯è€å®äººï¼Œæ‰€ä»¥å®æ—¶åˆ·æ–°åœ¨å›½å†…ç•¥æ˜¾å°´å°¬ï¼</p>
<p>JobIntentService ä¸å…·å¤‡å®æ—¶æ€§è´¨ï¼Œä¾‹å¦‚ä½ è¦æ¯åˆ†æ¯ç§’æ›´æ–°UIï¼Œè¿™ä¸é€‚åˆã€‚</p>
<h4 id="ç»¼ä¸Šæ‰€è¿°"><a href="#ç»¼ä¸Šæ‰€è¿°" class="headerlink" title="ç»¼ä¸Šæ‰€è¿°"></a>ç»¼ä¸Šæ‰€è¿°</h4><ul>
<li>è§£å†³åŠæ³•è®©ç”¨æˆ·æŠŠåº”ç”¨æœ¬èº«å¸¸é©»åå°ï¼Œä½†è¿™ä¼šå¢åŠ å†…å­˜çš„ä½¿ç”¨ï¼Œè€Œä¸”åº”ç”¨å¸¦æœ‰è‡ªåŠ¨ç½‘ç»œåˆ·æ–°ï¼Œè¿˜ä¼šå¢åŠ è€—ç”µã€‚</li>
<li>æˆ–è€…æ¥å…¥FCM (å›½å†…æ—¶çµæ—¶ä¸çµçš„ï¼Œçœ‹å½“åœ°ç½‘ç»œè„¸è‰²è¡Œäº‹)</li>
<li>æ¥å…¥å›½å†…æµæ°“æ¨é€å”¤é†’ï¼ˆå…¶å®åœ¨å›½å†…romçš„å¼ºæ€ä¸‹ï¼Œå·²ç»æ²¡ä»€ä¹ˆç”¨äº†ï¼Œä½†ç”¨æˆ·ä¸å»ä¸»åŠ¨å¼ºæ€ä¸»æµæ°“åº”ç”¨ï¼ˆä¸æ€å¾®ä¿¡ï¼Œæ·˜å®ï¼Œæ”¯ä»˜,qq ç­‰åº”ç”¨ï¼‰è¿˜æ˜¯å¯ä»¥ä¸€è¯•çš„ï¼‰</li>
<li>ç­‰å›½å†…ç»Ÿä¸€æ¨é€ï¼ˆæ—¶é—´æœªçŸ¥ï¼Ÿï¼Ÿï¼Ÿï¼Ÿï¼‰</li>
<li>JobIntentService</li>
</ul>
<blockquote>
<p>JobIntentService è¿˜æœ‰ä¸€ä¸ªç—›ç‚¹ï¼ŒJobIntentService é‡Œé¢çœŸçš„ä¸å¥½é…åˆ Kotlin åç¨‹ã€‚</p>
</blockquote>

      
    </div>
    
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2018/09/30/44-Android-ViewModel-ç¬”è®°/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption"><</strong>
      <div class="article-nav-title">
        
          ViewModel LiveData ç¬”è®°
        
      </div>
    </a>
  
  
    <a href="/2018/07/28/43-æˆ‘çš„å¸¸ç”¨å‘½ä»¤ç¬”è®°/" id="article-nav-older" class="article-nav-link-wrap">
      <div class="article-nav-title">æˆ‘çš„å¸¸ç”¨å‘½ä»¤ç¬”è®°</div>
      <strong class="article-nav-caption">></strong>
    </a>
  
</nav>

  
</article>


<div class="share">
	<div class="social-share"></div>

	<!--  css & js -->
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/social-share.js/1.0.16/css/share.min.css">
	<script src="https://cdnjs.cloudflare.com/ajax/libs/social-share.js/1.0.16/js/social-share.min.js"></script>
</div>





<div class="livere">
    <!-- æ¥å¿…åŠ›Cityç‰ˆå®‰è£…ä»£ç  -->
    <div id="lv-container" data-id="city" data-uid="MTAyMC8yODM1OC80OTMw">
        <script type="text/javascript">
       (function(d, s) {
           var j, e = d.getElementsByTagName(s)[0];

           if (typeof LivereTower === 'function') { return; }

           j = d.createElement(s);
           j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
           j.async = true;

           e.parentNode.insertBefore(j, e);
       })(document, 'script');
        </script>
    <noscript> ä¸ºæ­£å¸¸ä½¿ç”¨æ¥å¿…åŠ›è¯„è®ºåŠŸèƒ½è¯·æ¿€æ´»JavaScript</noscript>
    </div>
    <!-- Cityç‰ˆå®‰è£…ä»£ç å·²å®Œæˆ -->
</div>





</div>
      <footer id="footer">
  <div class="outer">
    <div id="footer-info">
    	<div class="footer-left">
    		&copy; 2019 ğ‘ºğ’‚ğ’.ğ‘´ğ’
    	</div>
      	<div class="footer-right">
      		<p>
            <a href="http://hexo.io/" target="_blank">Hexo</a>  Theme <a href="https://github.com/litten/hexo-theme-yilia" target="_blank">Yilia</a> by Litten    
            </p>
      	</div>
    </div>
  </div>
</footer>
    </div>
    
  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/mobile.js"></script>
<script src="/js/main.js"></script>


<!--ç™¾åº¦ç»Ÿè®¡çš„ä»£ç -->
<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?b7e1df5af826817394109f5f7425af1a";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>




  </div>
</body>
</html>